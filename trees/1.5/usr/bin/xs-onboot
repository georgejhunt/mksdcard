#!/bin/bash -x
# script that can run on boot, in the background

# following happens every boot
# if not access-point desired, and "br0" exists in ifcfg-wlan0, delete it
grep br0 /etc/sysconfig/network-scripts/ifcfg-wlan0
if [ ! -f /etc/xsce/access-point -a $? -eq 0 ]; then
   rm -f /etc/sysconfig/network-scripts/ifcfg-wlan0
fi

# if access-point desired, and any ifcfg has our hw_addr, delete it
if [ -f /etc/xsce/access-point  ]; then
    hardware_address=`cat /sys/class/net/wlan0/address`
    egrep -irn $hardware_address /etc/sysconfig/network-scripts/ifcfg-* | \
	        gawk -F":" '{print $1}' | xargs rm -f
fi

# for xo1.5, the bridge config file needs the hardware address
logger -s writing ifcfg-wlan0
if [ ! -h /sys/class/net/wlan0 ]; then
   sleep 5
fi
if [ -f /etc/xsce/access-point ]; then 
hardware_address=`cat /sys/class/net/wlan0/address`
cat <<EOF > /etc/sysconfig/network-scripts/ifcfg-wlan0
# Generated by XSCE
TYPE=Ethernet
BOOTPROTO=none
BRIDGE=br0
ONBOOT=yes
NM_CONTROLLED=no

# needs work but it's a start
HWADDR=$hardware_address
DEVICE=wlan0
EOF
else
cat <<EOF > /etc/sysconfig/network-scripts/ifcfg-wlan0
# Generated by XSCE
BOOTPROTO=dhcp
ONBOOT=yes
DEVICE=wlan0
EOF
fi

# If there is a USB dongle added, attach the dhclient to it
if [ ! -f /etc/sysconfig/network-scripts/ifcfg-eth0 ]; then
cat <<EOF > /etc/sysconfig/network-scripts/ifcfg-eth0
# Generated by XSCE
BOOTPROTO=dhcp
ONBOOT=yes
DEVICE=eth0
EOF
fi

if [ ! -f /etc/sysconfig/network-scripts/ifcfg-LAN ]; then
cat <<EOF >/etc/sysconfig/network-scripts/ifcfg-LAN
# Generated by XSCE
DEVICE=br0
TYPE=Bridge

BOOTPROTO=none
ONBOOT=yes
IPADDR=172.18.96.1
NETMASK=255.255.224.0
NM_CONTROLLED=yes
DNS1=127.0.0.1
DOMAIN=lan
NAME=xsce-LAN
EOF

fi

